# 用語集

## 設定ファイル

### アプリケーション設定ファイル

- **定義**: アプリケーションのデフォルト設定を定義するファイル
- **場所**: `{ベースディレクトリ}/.agent/clipmt/config/app.yml` または `{ベースディレクトリ}/.agent/clipmt/config/{プロファイルプレフィックス}-app.yml`
- **特徴**: 必須ファイル。省略不可。定義された項目以外は無視される
- **用途**: アプリケーションの基本動作設定を定義、working_dirの設定

### ユーザー設定ファイル

- **定義**: ユーザーごとのカスタム設定を定義するファイル
- **場所**: `{working_dir}/.agent/clipmt/config/user.yml` または `{working_dir}/.agent/clipmt/config/{プロファイルプレフィックス}-user.yml`
- **特徴**: オプショナル。存在しなくても正常処理
- **制約**: working_dirは設定不可（アプリケーション設定ファイルでのみ設定可能）

### YAML形式

- **定義**: 設定ファイルの記述形式
- **制約**: シンプルな単一ドキュメントのみ対応
- **特徴**: 人間が読みやすい構造化データ形式
- **用途**: アプリケーション設定ファイル、ユーザー設定ファイルの両方で使用

## 設定プロファイル

### 設定プロファイル

- **定義**: アプリケーション設定ファイルとユーザー設定ファイルの組み合わせを表す概念
- **種類**: デフォルトプロファイル（プレフィックスなし）と名前付きプロファイル（プレフィックスあり）
- **管理対象**: 同一アプリケーション内での複数設定セットの管理
- **選択方法**: コンストラクタの第1引数で指定

### デフォルトプロファイル

- **定義**: プロファイルプレフィックスを持たない基本の設定プロファイル
- **ファイル**: `app.yml` と `user.yml` の組み合わせ
- **使用例**: `new BreakdownConfig()`

### 名前付きプロファイル

- **定義**: 特定の名前（プロファイルプレフィックス）を持つ設定プロファイル
- **用途**: 環境別設定（development, staging, production）や機能別設定の実現
- **ファイル命名**: `{プロファイルプレフィックス}-app.yml`, `{プロファイルプレフィックス}-user.yml`
- **使用例**: `new BreakdownConfig("production")`

### 設定プロファイル名

- **定義**: 設定プロファイルを識別する名前
- **未指定時**: デフォルトプロファイルとして扱う
- **指定時**: 名前付きプロファイルのプロファイルプレフィックスとして使用
- **例**: "development", "production", "staging"

### プロファイルプレフィックス

- **定義**: 名前付きプロファイルを識別するために使用される文字列
- **制約**: 英数字とハイフンのみ使用可能（例：development, prod-v2）
- **適用ルール**: `{プロファイルプレフィックス}-{type}.yml` の形式で両ファイルに一貫適用
- **用途**: 設定ファイルの命名と読み込みロジックの統一管理

## ディレクトリとパス

### ベースディレクトリ

- **定義**: コンストラクタの第2引数で指定されるか、または現在の作業ディレクトリ
- **用途**: アプリケーション設定ファイルの配置基準となるディレクトリ
- **特徴**: ユーザー設定ファイルの配置基準（working_dir）とは独立
- **使用例**: `new BreakdownConfig(undefined, "/path/to/project")`

### working_dir

- **定義**: ユーザー設定ファイルの起点となる単一の基準ディレクトリ（システム全体で唯一）
- **スコープ**: システム全体の基準点（すべてのユーザー設定ファイルがこの配下に配置）
- **相対基準**: プロジェクトルート（実行時のカレントディレクトリ）からの相対パス
- **設定場所**: アプリケーション設定ファイルでのみ設定可能（ユーザー設定ファイルでは変更不可）
- **用途**: ユーザー設定ファイル（`{working_dir}/.agent/clipmt/config/user.yml`等）の配置場所を決定
- **デフォルト値**: "./.agent/clipmt"
- **参照**: `$working_dir` として他の設定やシステム内部で使用

### base_dir

- **定義**: 各機能（プロンプト、スキーマ）のファイル群を格納するディレクトリを指定するパラメータ
- **スコープ**: 機能別の個別ディレクトリ（app_prompt.base_dir, app_schema.base_dirなど）
- **相対基準**: プロジェクトルート（実行時のカレントディレクトリ）からの相対パス
- **設定場所**: app_prompt, app_schema の下位項目として個別設定
- **例**: `app_prompt.base_dir: "./.agent/clipmt/prompts/app"`

## メインクラスとコンポーネント

### BreakdownConfig

- **定義**: 設定ファイルの統合管理を行うメインクラス
- **機能**: アプリケーション設定ファイルとユーザー設定ファイルを読み込み、統合する
- **使用例**: `let config = new BreakdownConfig();`
- **責務**: 複数の設定ファイルの順序管理と値の上書き統合

### BreakdownLogger

- **定義**: ライブラリ専用のログ出力システム
- **用途**: テストコードのデバッグ、構造化ログの出力
- **ログレベル**: DEBUG, INFO, WARN, ERROR
- **制御**: 環境変数 `LOG_LEVEL` で制御可能

### ErrorManager

- **定義**: エラー管理を担当するコンポーネント
- **機能**: エラーメッセージの一元化、ログ出力の実行
- **用途**: システムとテストで共有可能なエラーメッセージ管理

## 設定項目

### app_prompt

- **定義**: プロンプトファイルの設定項目
- **設定項目**: `base_dir` (Baseフォルダの指定)
- **デフォルト値**: "./.agent/clipmt/prompts/app"
- **用途**: プロンプトファイルの場所を指定

### app_schema

- **定義**: Schemaファイルの設定項目
- **設定項目**: `base_dir` (Baseフォルダの指定)
- **デフォルト値**: "./.agent/clipmt/schema/app"
- **用途**: Schemaファイルの場所を指定

## 処理と操作

### 設定統合

- **定義**: 複数の設定ファイルを順序よく読み込み統合する処理
- **責任**: breakdownconfigライブラリが担当
- **手順**: アプリケーション設定ファイル読み込み → ユーザー設定ファイル読み込み → 値の上書き統合

### 上書き統合

- **定義**: アプリケーション設定ファイルの値をユーザー設定ファイルの値で置き換える処理
- **ルール**: ユーザー設定ファイルに存在するキーの最上位キーで上書き
- **優先順位**: ユーザー設定ファイル > アプリケーション設定ファイル
- **単位**: ネストされた階層の最上位キーが上書き単位

### バリデーション

- **定義**: 設定ファイルと設定値の妥当性を検証する処理
- **対象**:
  - ディレクトリの存在確認
  - パスの形式チェック
  - 設定ファイルの構文確認
- **提供機能**: ディレクトリ検証、ファイル存在検証のインターフェイス

### 型安全性チェック

- **定義**: コンパイル時に型の整合性を検証する処理
- **対象**: Discriminated Union、Result型、Smart Constructorの型チェック
- **利点**: 実行前に不正状態を検出
- **ツール**: TypeScriptコンパイラによる静的解析

### 網羅性チェック

- **定義**: switch文やパターンマッチですべてのケースが処理されているかの検証
- **実装**: TypeScriptの厳密な型チェック機能を使用
- **目標**: default句が不要な完全なケース分岐
- **利点**: 将来の型追加時の処理漏れ防止

## 開発とテスト

### デフォルト値

- **定義**: 設定ファイルが存在しない項目に対する初期値
- **提供方法**: アプリケーション側から求められた場合のみ返却
- **特徴**: ライブラリ内では直接利用せず、設定ファイルを優先

### fixture

- **定義**: テスト用の設定ファイルサンプル
- **方針**: 本番と同様の設定を使用する
- **理由**: 設定値の重要性から本番環境での動作保証を重視

### テスト階層

- **定義**: テストケースを段階的に分類する構造
- **階層**:
  1. **基本機能テスト**: 基本的な動作確認
  2. **主要機能テスト**: 実環境での動作確認
  3. **エッジケーステスト**: 特殊ケースの確認
  4. **エラーケーステスト**: エラー処理の確認

### 品質指標

- **定義**: コード品質を測定する基準
- **全域性原則の指標**:
  - ビジネスルールが型定義に反映されている
  - コンパイル時に不正状態を検出
  - switch文にdefault不要
  - 型アサーション使用量最小化
  - 関数の戻り値が予測可能

### 禁止パターン

- **定義**: 全域性原則に反するコーディングパターン
- **対象**:
  - `as Type`による強制型変換
  - オプショナルプロパティによる状態表現 `{ a?: X; b?: Y }`
  - `any`/`unknown`の安易な使用
  - 例外による制御フロー

### 推奨パターン

- **定義**: 全域性原則に沿った推奨コーディングパターン
- **対象**:
  - タグ付きユニオン： `{ kind: string; ... }`
  - Result型： `{ ok: boolean; ... }`
  - Smart Constructor： `private constructor + static create`
  - switch文による網羅的分岐

## ログとエラー

### ログレベル

- **定義**: ログ出力の重要度を示す分類
- **種類**:
  - **DEBUG**: デバッグ情報（テスト環境のみ）
  - **INFO**: 通常の情報
  - **WARN**: 警告情報
  - **ERROR**: エラー情報

## 設計原則

### 責務分割

- **定義**: 各コンポーネントの役割を明確に分離する設計手法
- **目的**: テスト容易性の向上、ハンドリングのしやすさ、疎結合の実現
- **効果**: エラーハンドリングとバリデーションの分散実装

### 疎結合

- **定義**: コンポーネント間の依存関係を最小限にする設計原則
- **利点**: テスト容易性、保守性、拡張性の向上
- **実装**: 責務分割による分散設計

### 全域性原則

- **定義**: 部分関数を全域関数に変換し、型システムで「ありえない状態」を排除する設計原則
- **目的**: コンパイル時に不正状態を検出し、実行時エラーを防止
- **核心理念**: ビジネスルールを型定義に反映し、型安全性を確保
- **適用範囲**: TypeScript/JavaScriptでの型安全なコード設計

## 型安全設計パターン

### Discriminated Union

- **定義**: タグ付きユニオンによる状態表現パターン
- **形式**: `{ kind: string; ... }` の形式でタグを持つオブジェクト
- **用途**: オプショナルプロパティの代替として明示的な状態管理
- **利点**: コンパイル時の網羅性チェック、switch文での分岐処理

### Smart Constructor

- **定義**: 制約のある値型を作成するパターン
- **構造**: プライベートコンストラクタ + 静的ファクトリメソッド
- **用途**: ビジネスルールに基づく値の制約チェック
- **例**: `private constructor + static create`

### Result型

- **定義**: エラーを値として扱うパターン
- **形式**: `{ ok: true; data: T } | { ok: false; error: E }`
- **用途**: 例外による制御フローの代替
- **利点**: エラーハンドリングの明示化、型安全性の向上

### 部分関数

- **定義**: 入力の一部に対してのみ定義された関数
- **問題**: `undefined`や`null`を返す可能性がある関数
- **例**: 配列の要素取得、辞書の値取得
- **解決**: 全域関数への変換

### 全域関数

- **定義**: すべての入力に対して定義された関数
- **特徴**: 戻り値が予測可能で型安全
- **実装方法**: Result型、Option型の使用
- **利点**: 実行時エラーの防止

## ビジネスルール設計

### ビジネスルール分析

- **定義**: 全域性適用前にドメイン知識を明確化する工程
- **観点**: 状態の洗い出し、遷移の定義、制約の明文化、例外ケースの特定
- **重要性**: 型設計の基盤となる要求仕様の理解
- **成果物**: ドメインルール定義書

### 状態遷移ルール

- **定義**: エンティティが持つ状態間の有効な変更パターン
- **用途**: Discriminated Unionの設計指針
- **記述方法**: 状態A → 状態B の形式
- **制約**: 禁止遷移の明示

### 値の制約

- **定義**: プロパティが持つべき値の範囲や形式の制限
- **例**: 割引率（0以上1以下）、在庫数（0以上の整数）
- **実装**: Smart Constructorによる制約チェック
- **用途**: ビジネスルールに基づく値の妥当性保証

---

## 重要概念の整理

### ベースディレクトリ と working_dir の違い

| 観点           | ベースディレクトリ                       | working_dir                      |
| -------------- | ------------------------------ | -------------------------------- |
| **目的**       | アプリケーション設定ファイルの配置基準 | ユーザー設定ファイルの基準点設定         |
| **数量**       | システム全体で1つ           | システム全体で1つのみ            |
| **設定者**     | コンストラクタまたは実行環境が決定   | アプリケーション設定ファイルで設定 |
| **変更可能性** | 実行時にコンストラクタで指定可能       | ユーザー設定ファイルでは変更不可         |
| **使用場面**   | アプリケーション設定ファイル読み込み時の基準       | ユーザー設定ファイル配置の基準   |
| **階層関係**   | working_dirとは独立            | すべてのユーザー設定ファイルの最上位     |

### パス解決の違い

- **アプリケーション設定ファイル**: `ベースディレクトリ + /.agent/clipmt/config/ + [プロファイルプレフィックス-]app.yml`
- **ユーザー設定ファイル**: `working_dir + /.agent/clipmt/config/ + [プロファイルプレフィックス-]user.yml`

### 設定例での比較

```yaml
# アプリケーション設定ファイル（app.yml）
working_dir: "./.agent/clipmt" # システム全体の基準
app_prompt:
  base_dir: "./.agent/clipmt/prompts/app" # プロンプト機能の基準
app_schema:
  base_dir: "./.agent/clipmt/schema/app" # スキーマ機能の基準
```

### 実際のファイル配置での理解

```
ベースディレクトリ/                    ← コンストラクタで指定またはカレントディレクトリ
├── .agent/clipmt/config/
│   ├── app.yml                      ← アプリケーション設定ファイル（デフォルトプロファイル）
│   └── production-app.yml           ← アプリケーション設定ファイル（名前付きプロファイル）

working_dir/                         ← アプリケーション設定ファイルで指定された場所
├── .agent/clipmt/config/
│   ├── user.yml                     ← ユーザー設定ファイル（デフォルトプロファイル）
│   └── production-user.yml          ← ユーザー設定ファイル（名前付きプロファイル）
├── prompts/app/                     ← app_prompt.base_dir が指す場所
│   └── default.txt
└── schema/app/                      ← app_schema.base_dir が指す場所
    └── default.json
```

### 設定ファイルの役割分担

- **アプリケーション設定ファイル**: システム構造の定義（working_dir, 各base_dir）
- **ユーザー設定ファイル**: 個別機能のカスタマイズ（base_dirの上書きなど）

### パス解決の原則

1. すべてのパスはプロジェクトルートからの相対パス
2. アプリケーション設定ファイルは`{ベースディレクトリ}/.agent/clipmt/config/`から読み込み
3. ユーザー設定ファイルは`{working_dir}/.agent/clipmt/config/`から読み込み
4. base_dirは実際のファイル操作時の基準ディレクトリ
5. ユーザー設定ファイルでbase_dirを上書き可能（working_dirは不可）

---

## ユビキタス言語

BreakdownConfigライブラリにおけるドメイン駆動設計のユビキタス言語定義。開発者、設計者、利用者間で共通理解を形成するための専門用語集。

### ドメイン固有用語一覧

| 用語 | 英語名 | 実装名 | 分類 | 英語表記 | 役割・責務 |
|------|--------|--------|------|----------|-----------|
| **アプリケーション設定ファイル** | application config file | `appConfig` | 設定ファイル | Application Config File | システムのデフォルト設定を定義 |
| **ユーザー設定ファイル** | user config file | `userConfig` | 設定ファイル | User Config File | ユーザー固有のカスタム設定を定義 |
| **設定プロファイル** | configuration profile | `configProfile` | プロファイル | Configuration Profile | 設定ファイルの組み合わせを管理 |
| **デフォルトプロファイル** | default profile | `defaultProfile` | プロファイル | Default Profile | プレフィックスなしの基本設定 |
| **名前付きプロファイル** | named profile | `namedProfile` | プロファイル | Named Profile | 環境別・用途別の専用設定 |
| **プロファイルプレフィックス** | profile prefix | `profilePrefix` | プロファイル | Profile Prefix | 名前付きプロファイルの識別子 |
| **ベースディレクトリ** | base directory | `baseDirectory` | ディレクトリ | Base Directory | アプリケーション設定の配置基準 |
| **working_dir** | working directory | `workingDir` | ディレクトリ | Working Directory | ユーザー設定の配置基準 |
| **base_dir** | base directory | `baseDir` | ディレクトリ | Base Directory | 機能別ファイル群の格納場所 |
| **設定統合** | configuration merging | `mergeConfig` | 処理 | Configuration Merging | 複数設定ファイルの統合処理 |
| **上書き統合** | override merging | `overrideConfig` | 処理 | Override Merging | ユーザー設定による値の置換 |
| **プロファイル選択** | profile selection | `selectProfile` | 処理 | Profile Selection | 利用する設定プロファイルの決定 |
| **パス解決** | path resolution | `resolvePath` | 処理 | Path Resolution | 設定ファイルの場所特定 |
| **設定プロファイル名** | configuration profile name | `profileName` | 識別子 | Configuration Profile Name | プロファイルを識別する名前 |
| **app_prompt** | app_prompt | `appPrompt` | 設定項目 | Application Prompt | プロンプトファイルの設定 |
| **app_schema** | app_schema | `appSchema` | 設定項目 | Application Schema | スキーマファイルの設定 |

### ドメインルール表現

| ドメインルール | 表現 |
|---------------|------|
| **必須性** | アプリケーション設定ファイルは必須、ユーザー設定ファイルはオプショナル |
| **一意性** | working_dirはシステム全体で唯一、ベースディレクトリは実行時決定 |
| **階層性** | ユーザー設定ファイル > アプリケーション設定ファイル の優先順位 |
| **制約性** | working_dirはアプリケーション設定でのみ設定可能 |
| **命名規則** | `{プロファイルプレフィックス}-{type}.yml` の統一形式 |
| **配置規則** | `.agent/clipmt/config/` 配下への統一配置 |

### 概念モデル関係

```
BreakdownConfig
├── 設定プロファイル
│   ├── アプリケーション設定ファイル (必須)
│   └── ユーザー設定ファイル (オプショナル)
├── ディレクトリ構造
│   ├── ベースディレクトリ → アプリケーション設定
│   └── working_dir → ユーザー設定
└── 処理フロー
    ├── パス解決
    ├── 設定統合
    └── 上書き統合
```

### 用語使用ガイドライン

1. **一貫性**: ドキュメント・コード・議論で同一用語を使用
2. **明確性**: 曖昧な表現を避け、定義された用語を優先
3. **階層性**: 上位概念から下位概念への論理的構造を維持
4. **実装中立性**: 技術実装に依存しない概念レベルでの表現
