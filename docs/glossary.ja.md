# 用語集

## 設定ファイル

### アプリケーション設定ファイル

- **定義**: アプリケーションのデフォルト設定を定義するファイル
- **場所**: `{ベースディレクトリ}/.agent/breakdown/config/app.yml` または `{ベースディレクトリ}/.agent/breakdown/config/{プロファイルプレフィックス}-app.yml`
- **特徴**: 必須ファイル。省略不可。定義された項目以外は無視される
- **用途**: アプリケーションの基本動作設定を定義、working_dirの設定

### ユーザー設定ファイル

- **定義**: ユーザーごとのカスタム設定を定義するファイル
- **場所**: `{working_dir}/.agent/breakdown/config/user.yml` または `{working_dir}/.agent/breakdown/config/{プロファイルプレフィックス}-user.yml`
- **特徴**: オプショナル。存在しなくても正常処理
- **制約**: working_dirは設定不可（アプリケーション設定ファイルでのみ設定可能）

### YAML形式

- **定義**: 設定ファイルの記述形式
- **制約**: シンプルな単一ドキュメントのみ対応
- **特徴**: 人間が読みやすい構造化データ形式
- **用途**: アプリケーション設定ファイル、ユーザー設定ファイルの両方で使用

## 設定プロファイル

### 設定プロファイル

- **定義**: アプリケーション設定ファイルとユーザー設定ファイルの組み合わせを表す概念
- **種類**: デフォルトプロファイル（プレフィックスなし）と名前付きプロファイル（プレフィックスあり）
- **管理対象**: 同一アプリケーション内での複数設定セットの管理
- **選択方法**: コンストラクタの第1引数で指定

### デフォルトプロファイル

- **定義**: プロファイルプレフィックスを持たない基本の設定プロファイル
- **ファイル**: `app.yml` と `user.yml` の組み合わせ
- **使用例**: `new BreakdownConfig()`

### 名前付きプロファイル

- **定義**: 特定の名前（プロファイルプレフィックス）を持つ設定プロファイル
- **用途**: 環境別設定（development, staging, production）や機能別設定の実現
- **ファイル命名**: `{プロファイルプレフィックス}-app.yml`, `{プロファイルプレフィックス}-user.yml`
- **使用例**: `new BreakdownConfig("production")`

### 設定プロファイル名

- **定義**: 設定プロファイルを識別する名前
- **未指定時**: デフォルトプロファイルとして扱う
- **指定時**: 名前付きプロファイルのプロファイルプレフィックスとして使用
- **例**: "development", "production", "staging"

### プロファイルプレフィックス

- **定義**: 名前付きプロファイルを識別するために使用される文字列
- **制約**: 英数字とハイフンのみ使用可能（例：development, prod-v2）
- **適用ルール**: `{プロファイルプレフィックス}-{type}.yml` の形式で両ファイルに一貫適用
- **用途**: 設定ファイルの命名と読み込みロジックの統一管理

## ディレクトリとパス

### ベースディレクトリ

- **定義**: コンストラクタの第2引数で指定されるか、または現在の作業ディレクトリ
- **用途**: アプリケーション設定ファイルの配置基準となるディレクトリ
- **特徴**: ユーザー設定ファイルの配置基準（working_dir）とは独立
- **使用例**: `new BreakdownConfig(undefined, "/path/to/project")`

### working_dir

- **定義**: ユーザー設定ファイルの起点となる単一の基準ディレクトリ（システム全体で唯一）
- **スコープ**: システム全体の基準点（すべてのユーザー設定ファイルがこの配下に配置）
- **相対基準**: プロジェクトルート（実行時のカレントディレクトリ）からの相対パス
- **設定場所**: アプリケーション設定ファイルでのみ設定可能（ユーザー設定ファイルでは変更不可）
- **用途**: ユーザー設定ファイル（`{working_dir}/.agent/breakdown/config/user.yml`等）の配置場所を決定
- **デフォルト値**: "./.agent/breakdown"
- **参照**: `$working_dir` として他の設定やシステム内部で使用

### base_dir

- **定義**: 各機能（プロンプト、スキーマ）のファイル群を格納するディレクトリを指定するパラメータ
- **スコープ**: 機能別の個別ディレクトリ（app_prompt.base_dir, app_schema.base_dirなど）
- **相対基準**: プロジェクトルート（実行時のカレントディレクトリ）からの相対パス
- **設定場所**: app_prompt, app_schema の下位項目として個別設定
- **例**: `app_prompt.base_dir: "./.agent/breakdown/prompts/app"`

## メインクラスとコンポーネント

### BreakdownConfig

- **定義**: 設定ファイルの統合管理を行うメインクラス
- **機能**: アプリケーション設定ファイルとユーザー設定ファイルを読み込み、統合する
- **使用例**: `let config = new BreakdownConfig();`
- **責務**: 複数の設定ファイルの順序管理と値の上書き統合

### BreakdownLogger

- **定義**: ライブラリ専用のログ出力システム
- **用途**: テストコードのデバッグ、構造化ログの出力
- **ログレベル**: DEBUG, INFO, WARN, ERROR
- **制御**: 環境変数 `LOG_LEVEL` で制御可能

### ErrorManager

- **定義**: エラー管理を担当するコンポーネント
- **機能**: エラーメッセージの一元化、ログ出力の実行
- **用途**: システムとテストで共有可能なエラーメッセージ管理

## 設定項目

### app_prompt

- **定義**: プロンプトファイルの設定項目
- **設定項目**: `base_dir` (Baseフォルダの指定)
- **デフォルト値**: "./.agent/breakdown/prompts/app"
- **用途**: プロンプトファイルの場所を指定

### app_schema

- **定義**: Schemaファイルの設定項目
- **設定項目**: `base_dir` (Baseフォルダの指定)
- **デフォルト値**: "./.agent/breakdown/schema/app"
- **用途**: Schemaファイルの場所を指定

## 処理と操作

### 設定統合

- **定義**: 複数の設定ファイルを順序よく読み込み統合する処理
- **責任**: breakdownconfigライブラリが担当
- **手順**: アプリケーション設定ファイル読み込み → ユーザー設定ファイル読み込み → 値の上書き統合

### 上書き統合

- **定義**: アプリケーション設定ファイルの値をユーザー設定ファイルの値で置き換える処理
- **ルール**: ユーザー設定ファイルに存在するキーの最上位キーで上書き
- **優先順位**: ユーザー設定ファイル > アプリケーション設定ファイル
- **単位**: ネストされた階層の最上位キーが上書き単位

### バリデーション

- **定義**: 設定ファイルと設定値の妥当性を検証する処理
- **対象**:
  - ディレクトリの存在確認
  - パスの形式チェック
  - 設定ファイルの構文確認
- **提供機能**: ディレクトリ検証、ファイル存在検証のインターフェイス

## 開発とテスト

### デフォルト値

- **定義**: 設定ファイルが存在しない項目に対する初期値
- **提供方法**: アプリケーション側から求められた場合のみ返却
- **特徴**: ライブラリ内では直接利用せず、設定ファイルを優先

### fixture

- **定義**: テスト用の設定ファイルサンプル
- **方針**: 本番と同様の設定を使用する
- **理由**: 設定値の重要性から本番環境での動作保証を重視

### テスト階層

- **定義**: テストケースを段階的に分類する構造
- **階層**:
  1. **基本機能テスト**: 基本的な動作確認
  2. **主要機能テスト**: 実環境での動作確認
  3. **エッジケーステスト**: 特殊ケースの確認
  4. **エラーケーステスト**: エラー処理の確認

## ログとエラー

### ログレベル

- **定義**: ログ出力の重要度を示す分類
- **種類**:
  - **DEBUG**: デバッグ情報（テスト環境のみ）
  - **INFO**: 通常の情報
  - **WARN**: 警告情報
  - **ERROR**: エラー情報

## 設計原則

### 責務分割

- **定義**: 各コンポーネントの役割を明確に分離する設計手法
- **目的**: テスト容易性の向上、ハンドリングのしやすさ、疎結合の実現
- **効果**: エラーハンドリングとバリデーションの分散実装

### 疎結合

- **定義**: コンポーネント間の依存関係を最小限にする設計原則
- **利点**: テスト容易性、保守性、拡張性の向上
- **実装**: 責務分割による分散設計

---

## 重要概念の整理

### ベースディレクトリ と working_dir の違い

| 観点           | ベースディレクトリ                       | working_dir                      |
| -------------- | ------------------------------ | -------------------------------- |
| **目的**       | アプリケーション設定ファイルの配置基準 | ユーザー設定ファイルの基準点設定         |
| **数量**       | システム全体で1つ           | システム全体で1つのみ            |
| **設定者**     | コンストラクタまたは実行環境が決定   | アプリケーション設定ファイルで設定 |
| **変更可能性** | 実行時にコンストラクタで指定可能       | ユーザー設定ファイルでは変更不可         |
| **使用場面**   | アプリケーション設定ファイル読み込み時の基準       | ユーザー設定ファイル配置の基準   |
| **階層関係**   | working_dirとは独立            | すべてのユーザー設定ファイルの最上位     |

### パス解決の違い

- **アプリケーション設定ファイル**: `ベースディレクトリ + /.agent/breakdown/config/ + [プロファイルプレフィックス-]app.yml`
- **ユーザー設定ファイル**: `working_dir + /.agent/breakdown/config/ + [プロファイルプレフィックス-]user.yml`

### 設定例での比較

```yaml
# アプリケーション設定ファイル（app.yml）
working_dir: "./.agent/breakdown" # システム全体の基準
app_prompt:
  base_dir: "./.agent/breakdown/prompts/app" # プロンプト機能の基準
app_schema:
  base_dir: "./.agent/breakdown/schema/app" # スキーマ機能の基準
```

### 実際のファイル配置での理解

```
ベースディレクトリ/                    ← コンストラクタで指定またはカレントディレクトリ
├── .agent/breakdown/config/
│   ├── app.yml                      ← アプリケーション設定ファイル（デフォルトプロファイル）
│   └── production-app.yml           ← アプリケーション設定ファイル（名前付きプロファイル）

working_dir/                         ← アプリケーション設定ファイルで指定された場所
├── .agent/breakdown/config/
│   ├── user.yml                     ← ユーザー設定ファイル（デフォルトプロファイル）
│   └── production-user.yml          ← ユーザー設定ファイル（名前付きプロファイル）
├── prompts/app/                     ← app_prompt.base_dir が指す場所
│   └── default.txt
└── schema/app/                      ← app_schema.base_dir が指す場所
    └── default.json
```

### 設定ファイルの役割分担

- **アプリケーション設定ファイル**: システム構造の定義（working_dir, 各base_dir）
- **ユーザー設定ファイル**: 個別機能のカスタマイズ（base_dirの上書きなど）

### パス解決の原則

1. すべてのパスはプロジェクトルートからの相対パス
2. アプリケーション設定ファイルは`{ベースディレクトリ}/.agent/breakdown/config/`から読み込み
3. ユーザー設定ファイルは`{working_dir}/.agent/breakdown/config/`から読み込み
4. base_dirは実際のファイル操作時の基準ディレクトリ
5. ユーザー設定ファイルでbase_dirを上書き可能（working_dirは不可）
