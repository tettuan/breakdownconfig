# Discriminated Union適用対象の洗い出し指示書

## 目的

`@drafts/20250626-totality-is-all-you-need.md`で定義された**全域性（Totality）**の概念に基づき、現在のコードベースに存在する**部分関数（Partial Function）**となりうる実装を特定し、**Discriminated Union**パターンの適用によって、より堅牢な型設計へリファクタリングすることを目的とする。

## 背景

現在の型定義、特に`UserConfig`や`MergedConfig`では、オプショナルなプロパティ（`?`）やインデックスシグネチャ（`[key: string]: ...`）が多用されている。これにより、以下のような問題が発生する可能性がある。

- **不正な状態の許容**: 仕様上ありえない、または意味をなさないプロパティの組み合わせが型レベルで許容されてしまう。
- **暗黙の前提への依存**: 関数やコンポーネントが、特定のプロパティが存在すること、または特定の型であることを暗黙的に期待してしまい、呼び出し側の実装に安全性が依存する。
- **網羅性の欠如**: `if`文や`?.`（オプショナルチェイニング）によるプロパティの存在チェックが散在し、将来的な仕様変更時にチェック漏れが発生しやすい。

これらの問題を解決するため、状態や種類によって構造が変化するオブジェクトをDiscriminated Unionを用いて再定義し、型安全性を向上させる。

## 洗い出しタスク

以下の観点に基づき、コードベース全体からDiscriminated Unionの適用候補となる箇所を全てリストアップせよ。

### 1. オプショナルなプロパティに依存した条件分岐の特定

`if (obj.property)`や`if (obj.property !== undefined)`、三項演算子、`?.`（オプショナルチェイニング）など、特定のプロパティの**存在有無**によって処理が分岐している箇所を全て特定する。

**チェックリスト:**

- [ ] `UserConfig`のオプショナルなプロパティ（`app_prompt`, `app_schema`）の存在チェックを行っている箇所。
- [ ] `if`文や三項演算子で、プロパティの存在をチェックし、処理を切り替えている箇所。
- [ ] オプショナルチェイニング（`?.`）の後に、Null合体演算子（`??`）が続くことで、デフォルト値を設定している箇所。これは、特定の状態が存在しないことを暗黙的に示している可能性がある。

### 2. 特定の文字列リテラルや値による処理の分岐

オブジェクト内の特定のプロパティが持つ**値**（特に文字列リテラル）によって、処理のロジックが大きく変わる箇所を特定する。

**例:**

```typescript
if (config.type === "A") {
  // Aの処理
} else if (config.type === "B") {
  // Bの処理
}
```

このような実装は、`type`を`kind`のようなdiscriminatorとするDiscriminated Unionで表現できる可能性が高い。

**チェックリスト:**

- [ ] 特定のキーの値（例：`'production'`, `'development'`）によって、設定や挙動が変わる箇所。
- [ ] `switch`文が使われているが、`default`節でエラーを投げるなど、網羅性が保証されていない箇所。

### 3. 互いに排他的であるべきプロパティの組み合わせ

複数のオプショナルなプロパティが存在し、仕様上、それらが同時に存在してはならない、もしくはいずれか一つだけが存在すべきであるような型定義を特定する。

**例:**
`@drafts/20250626-totality-is-all-you-need.md`の`Discount`型のように、`rate`と`fixedAmount`が同時に存在すべきでないケース。

**チェックリスト:**

- [ ] `AppConfig`, `UserConfig`, `MergedConfig`内で、意味的に同時に存在し得ない、あるいはどちらか一方が必須となるようなプロパティの組み合わせがないか検討する。
- [ ] 現在の実装では、複数のプロパティが同時に存在した場合の優先順位やエラー処理が、`if-else if`の順序などによって暗黙的に決定されていないか確認する。

### 4. インデックスシグネチャに依存する動的な処理

`[key: string]: ...`のインデックスシグネチャを持つオブジェクトから、動的にプロパティを読み出して処理を行っている箇所を特定する。

これらの処理は、本来であれば固定的なプロパティとして定義できる可能性がある。もし、特定のキーの集合が期待されているのであれば、それらを具体的な型として定義し、Discriminated Unionへリファクタリングできるかもしれない。

**チェックリスト:**

- [ ] `MergedConfig`や`UserConfig`のインデックスシグネチャから、特定のキーを期待して値を取得している箇所。
- [ ] `Object.keys()`や`for...in`ループを使い、オブジェクトのキーに基づいて処理を行っている箇所。

## アウトプット形式

上記の各タスクで見つかったコード箇所について、以下の情報をまとめること。

- **ファイルパスと行番号**
- **対象となるコードスニペット**
- **問題点**: なぜそれが部分関数的であり、どのような不正な状態を許容してしまうのか。
- **リファクタリング案**: Discriminated Unionを用いてどのように改善できるかの具体的な提案（型定義の例、`switch`文による処理分岐の例など）。

この指示書に基づき、コードベースの全域性を高めるための具体的なリファクタリング対象を洗い出すこと。
