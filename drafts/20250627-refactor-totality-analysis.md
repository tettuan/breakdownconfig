# プロジェクト: Total Function

現在の`src/`配下の実装を全域関数（Total Function）による設計にリファクタリングする。部分関数による不安定性を排除し、型安全性を強化して、バグに強いコード設計を実現する。

以下に、実施中のタスクを再送する。
実装状況を確認し、作業を再開し、不足部分を修正して。

`Total Function` について、必ず `docs/totality.md` を参照すること。
ビジネスドメイン情報は、 docs/ を調べて把握すること。


# チームの構成

あなたは指揮官であり上司である。
最初にチームを立ち上げて進める。

`instructions/team-head.ja.md` に詳細の記載がある。
チーム立ち上げの指示なので、必ず最初に読むこと。
各paneの存在を確認し、無ければ起動し、あればClaudeの起動を確認すること。全員を調べ、Claudeが起動していない部下に対し,Claude起動する。

# 実施内容

ビジネスドメイン情報を、 `docs/` を調べて把握する。
結果を tmp/ 配下に作成し、ドメイン情報として整備する。

## 1. リファクタリング対象の特定

### 1.1 MergedConfig型の置き換え

#### Action 1: 厳密な型定義の実装

**対象ファイル**: `src/types/merged_config.ts`

#### Action 2: ConfigManagerのエラーハンドリング修正

**対象ファイル**: `src/config_manager.ts`

**修正対象メソッド**: `loadUserConfig()`


### 1.2 AppConfigLoaderのバリデーション強化

#### Action 3: 全域関数によるバリデーション実装

**対象ファイル**: `src/loaders/app_config_loader.ts`

**修正対象メソッド**: `validateConfig()`

## 2. 新規ファイルの作成

### 2.1 新しい型定義ファイルの作成

#### Action 4: ConfigResult型の作成

**新規ファイル**: `src/types/config_result.ts`

#### Action 5: ValidPath Smart Constructorの実装

**新規ファイル**: `src/utils/valid_path.ts`

### 2.2 SafeConfigLoaderの実装

#### Action 6: 全域関数ローダーの作成

**新規ファイル**: `src/loaders/safe_config_loader.ts`

## 3. 既存ファイルの段階的修正

### 3.1 ConfigManagerの全面リファクタリング

#### Action 7: エラー処理の統一

**対象ファイル**: `src/config_manager.ts`

**修正内容**:

1. 全てのメソッドの戻り値を`ConfigResult<T>`に変更
2. エラーの詳細情報を保持する仕組みを追加
3. 設定のマージ処理を全域関数として実装

### 3.2 ローダークラスの改修

#### Action 8: AppConfigLoaderの全面改修

**対象ファイル**: `src/loaders/app_config_loader.ts`

**修正内容**:

1. `load()`メソッドの戻り値を`ConfigResult<AppConfig>`に変更
2. 例外処理をResult型で統一
3. バリデーションロジックの強化

#### Action 9: UserConfigLoaderの改修

**対象ファイル**: `src/loaders/user_config_loader.ts`

**修正内容**:

1. オプショナルな設定ファイルの扱いを明確化
2. 「設定なし」と「設定エラー」を明確に区別
3. 戻り値の型を統一

---

## 4. テストの追加・修正

### 4.1 新しい型に対応したテストの作成

#### Action 10: 全域関数のテスト追加

**新規ファイル**: `tests/config/totality_test.ts`


### 4.2 既存テストの修正

#### Action 11: 既存テストファイルの戻り値対応

**対象ファイル**: `tests/config/loading_test.ts`, `tests/config/validation_test.ts`

**修正内容**:

- `ConfigResult<T>`型への対応
- エラーケースのテスト強化
- 網羅的なテストケースの追加

## 6. 検証方法

### 6.1 型安全性の検証

```bash
# TypeScriptコンパイラによる型チェック
deno check src/**/*.ts

# 型エラーが0件であることを確認
```

### 6.2 網羅性の検証

```bash
# 全てのテストケースが通ることを確認
deno test --coverage

# カバレッジが95%以上であることを確認
deno coverage --html

# ローカルCIの実行で完全なテストを網羅
deno task ci 
```

### 6.3 実行時エラーの削減確認

```bash
# 既存の例外キャッチが削除されていることを確認
grep -r "catch.*Error" src/ | wc -l  # 0になるべき

# Result型が適切に使用されていることを確認
grep -r "ConfigResult" src/ | wc -l  # 十分な数があるべき
```

---

## 7. 成功指標

### 7.1 定量的指標

1. **型エラー**: 0件（コンパイル時）
2. **実行時例外**: 0件（正常系テスト）
3. **テストカバレッジ**: 95%以上
4. **未処理エラーケース**: 0件

### 7.2 定性的指標

1. **可読性**: 全てのエラーケースが明示的
2. **保守性**: 新しい設定項目の追加が型安全
3. **デバッグ性**: エラーの原因が明確に特定可能
4. **拡張性**: 新しいローダーの追加が容易

## タスクの進め方

- Git:
  - 現在のGitブランチが適切か判断する (see @docs/claude/git-workflow.md)
  - 作成が必要なら Git ブランチを作成し、移動する
- サイクル: 仕様把握 → 調査 → 計画・設計 → 実行 → 記録・検証 → 学習 → 仕様把握へ戻る
- アサイン: サイクル段階に応じて、メンバーの役割を変更し最適アサイン。常時フル稼働を目指す。

### 進捗更新

- 進捗させるべきタスクは `tmp/tasks.md` に書き出し、完了マークをつけたりしながら進めてください。
- すべてが完了したら、`tmp/completed.md` に完了したレポートを記録してください。

# 作業開始指示

まずチームを立ち上げます。
チーム全体のパフォーマンスが重要です。
ワーカープールマネージャーを活躍させ、部下であるゴルーチンをフル稼働させてください。
今なにをすべきか（タスク分割や、状況整理、要件定義）について、ワーカープールマネージャーが把握していることが重要です。
ワーカープールマネージャーから、今やる詳細タスクへ分割し、部下ゴルーチンへ割り当てさせてください。

プロジェクトの成功を祈ります。開始してください。
